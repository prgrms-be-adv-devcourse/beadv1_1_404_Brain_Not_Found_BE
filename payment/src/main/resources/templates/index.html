<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>결제 확인</title>
    <link rel="stylesheet" href="/modal-page.css"/>
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>

<body>
<div class="wrapper" th:with="originPrice = ${amount} + 149900">

    <div class="product-section">

        <div class="product-info">
            <div class="product-details">
                <h2 th:text="${productName}">상품명</h2>
                <p>주문번호: <span th:text="${orderId}">주문번호</span></p>
            </div>
            <div class="product-price">
                <p class="price-original">₩ [[ ${originPrice} ]] </p>
                <p class="price-final">
                    <span class="currency">₩ </span>
                    <span th:text="${#numbers.formatInteger(amount, 0, 'COMMA')}">[[ ${amount} ]]</span>
                </p>
            </div>

        </div>

        <div class="product-summary">

            <div class="summary-row">
                <span class="summary-label">상품금액</span>
                <span class="summary-value">₩ [[ ${originPrice} ]]</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">할인금액</span>
                <span class="summary-value">-₩ 149900 </span>
            </div>

            <div class="summary-row">
                <span class="summary-label">배송비</span>
                <span class="summary-value">무료</span>
            </div>

            <div class="summary-row">
                <span class="summary-label">총 결제금액</span>
                <span class="summary-value">₩ <span th:text="${#numbers.formatInteger(amount, 0, 'COMMA')}">[[ ${amount} ]]</span> </span>
            </div>

        </div>

    </div>

    <div class="box_section">

        <div id="payment-method"></div>
        <div id="agreement"></div>

        <div class="result wrapper">
            <button class="button" id="payment-button" style="margin-top: 30px">
                결제하기
            </button>
        </div>

    </div>

</div>

<script th:inline="javascript">
    main();

    async function main() {
        const button = document.getElementById("payment-button");
        
        // Thymeleaf로 전달된 값들을 JavaScript 변수로 설정
        const orderId = /*[[${orderId}]]*/ '';
        const orderName = /*[[${productName}]]*/ '';
        const amountValue = /*[[${amount}]]*/ 0;
        const clientKeyValue = /*[[${clientKey}]]*/ '';
        const successUrlValue = /*[[${successUrl}]]*/ '';
        const failUrlValue = /*[[${failUrl}]]*/ '';
        const customerNameValue = /*[[${customerName}]]*/ '고객';
        
        // 디버깅: 값 확인
        console.log("orderId:", orderId);
        console.log("orderName:", orderName);
        console.log("amountValue:", amountValue);
        console.log("clientKeyValue:", clientKeyValue);
        console.log("successUrlValue:", successUrlValue);
        console.log("failUrlValue:", failUrlValue);
        
        // clientKey가 비어있으면 에러
        if (!clientKeyValue || clientKeyValue.trim() === '') {
            alert("클라이언트 키가 설정되지 않았습니다. 설정을 확인해주세요.");
            return;
        }
        
        const amount = {
            currency: "KRW",
            value: amountValue,
        };

        try {
            const tossPayments = TossPayments(clientKeyValue);
            console.log("TossPayments 초기화 완료");

            const widgets = tossPayments.widgets({customerKey: TossPayments.ANONYMOUS});
            await widgets.setAmount(amount);
            console.log("결제 금액 설정 완료:", amount);

            await widgets.renderPaymentMethods({
                selector: "#payment-method",
                variantKey: "DEFAULT",
            });
            console.log("결제 수단 렌더링 완료");

            await widgets.renderAgreement({selector: "#agreement", variantKey: "AGREEMENT"});
            console.log("약관 동의 렌더링 완료");

            button.addEventListener("click", async function () {
                try {
                    console.log("결제 요청 시작");
                    await widgets.requestPayment({
                        orderId: "ORDER-" + orderId,
                        orderName: orderName,
                        successUrl: successUrlValue,
                        failUrl: failUrlValue,
                        customerEmail: "customer@example.com",
                        customerName: customerNameValue,
                    });
                } catch (error) {
                    console.error("결제 요청 실패:", error);
                    alert("결제 요청 중 오류가 발생했습니다: " + error.message);
                }
            });
        } catch (error) {
            console.error("위젯 초기화 실패:", error);
            alert("결제 위젯 초기화 중 오류가 발생했습니다: " + error.message);
        }
    }

</script>
</body>
</html>