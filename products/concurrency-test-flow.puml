@startuml
!theme plain
skinparam backgroundColor #FFFFFF

participant "사용자1\n(Thread-1)" as U1
participant "사용자2\n(Thread-2)" as U2
participant "ProductService" as PS
database "MySQL\n(락)" as DB

== 동시 시작 ==
par
    U1 -> PS: updateInventory(code, -3)
and
    U2 -> PS: updateInventory(code, -3)
end

== 락 경쟁 ==
PS -> DB: SELECT ... FOR UPDATE\n(비관적 락)
note right: 사용자2가 먼저 락 획득

== 사용자2 처리 ==
DB --> PS: 락 획득
PS -> DB: 재고 확인 (5개)
PS -> DB: UPDATE quantity = 2
PS -> PS: InventoryHistory 저장
DB --> PS: 커밋 완료
PS --> U2: 성공 ✅

== 사용자1 처리 ==
U1 -> DB: SELECT ... FOR UPDATE\n(대기 중...)
note right: 사용자2 커밋 후 락 획득
DB --> U1: 락 획득
U1 -> DB: 재고 확인 (2개)
DB --> U1: InsufficientInventoryException\n(재고 부족)
U1 -> DB: 롤백
PS --> U1: 실패 ❌

@enduml

