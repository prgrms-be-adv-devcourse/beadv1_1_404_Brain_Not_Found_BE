<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 생성</title>
</head>
<body>
    <div class="container">
        <h2>주문 생성</h2>
        <form id="orderForm" method="POST" action="/orders/create">
            <input type="hidden" name="userCode" id="userCode" value="USER-001">
            
            <div class="form-group">
                <label for="cartCode">장바구니 코드 *</label>
                <input type="text" id="cartCode" name="cartCode" required value="CART-001">
            </div>

            <div class="form-group">
                <label for="name">구매자 이름 *</label>
                <input type="text" id="name" name="name" required value="홍길동">
            </div>

            <div class="form-group">
                <label for="address">배송지 주소 *</label>
                <input type="text" id="address" name="address" required value="서울시 강남구 테헤란로 123">
            </div>

            <div class="form-group">
                <label for="orderType">주문 유형 *</label>
                <select id="orderType" name="orderType" required>
                    <option value="ONLINE">온라인</option>
                    <option value="OFFLINE">오프라인</option>
                </select>
            </div>

            <h3>상품 정보</h3>
            <div id="products">
                <div class="product-item" data-product-index="0">
                    <h4>상품 1</h4>
                    <div class="form-group">
                        <label>상품 코드 *</label>
                        <input type="text" name="products[0].productCode" required value="PROD-001">
                    </div>
                    <div class="form-group">
                        <label>수량 *</label>
                        <input type="number" name="products[0].quantity" min="1" required value="1">
                    </div>
                    <div class="form-group">
                        <label>가격 *</label>
                        <input type="number" name="products[0].price" min="1" required value="10000">
                    </div>
                    <div class="form-group">
                        <label>이미지 URL</label>
                        <input type="text" name="products[0].image" value="">
                    </div>
                </div>
            </div>

            <button type="button" class="add-product-btn" onclick="addProduct()">+ 상품 추가</button>

            <div class="form-group">
                <label for="totalPrice">총 결제 금액 *</label>
                <input type="number" id="totalPrice" name="totalPrice" min="1" required value="10000">
                <small class="error">상품 가격과 수량을 입력하면 자동으로 계산됩니다.</small>
            </div>

            <input type="hidden" name="paidType" value="TOSS_PAYMENT">
            <input type="hidden" name="paymentKey" value="">

            <button type="submit" id="submitBtn">주문하기</button>
        </form>
    </div>

    <script>
        let productIndex = 1;

        function addProduct() {
            const productsDiv = document.getElementById('products');
            const newProduct = document.createElement('div');
            newProduct.className = 'product-item';
            newProduct.setAttribute('data-product-index', productIndex);
            
            newProduct.innerHTML = `
                <h4>상품 ${productIndex + 1}</h4>
                <div class="form-group">
                    <label>상품 코드 *</label>
                    <input type="text" name="products[${productIndex}].productCode" required value="PROD-${String(productIndex + 1).padStart(3, '0')}">
                </div>
                <div class="form-group">
                    <label>수량 *</label>
                    <input type="number" name="products[${productIndex}].quantity" min="1" required value="1" onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label>가격 *</label>
                    <input type="number" name="products[${productIndex}].price" min="1" required value="10000" onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label>이미지 URL</label>
                    <input type="text" name="products[${productIndex}].image" value="">
                </div>
                <button type="button" class="remove-product-btn" onclick="removeProduct(${productIndex})">상품 제거</button>
            `;
            
            productsDiv.appendChild(newProduct);
            productIndex++;
            calculateTotal();
        }

        function removeProduct(index) {
            const product = document.querySelector(`[data-product-index="${index}"]`);
            if (product) {
                product.remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            const products = document.querySelectorAll('.product-item');
            let total = 0;
            
            products.forEach(product => {
                const quantity = parseInt(product.querySelector('input[name*="quantity"]').value) || 0;
                const price = parseInt(product.querySelector('input[name*="price"]').value) || 0;
                total += quantity * price;
            });
            
            document.getElementById('totalPrice').value = total;
        }

        // 초기 상품의 가격/수량 변경 시 총액 계산
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInputs = document.querySelectorAll('input[name*="quantity"]');
            const priceInputs = document.querySelectorAll('input[name*="price"]');
            
            quantityInputs.forEach(input => {
                input.addEventListener('change', calculateTotal);
            });
            
            priceInputs.forEach(input => {
                input.addEventListener('change', calculateTotal);
            });
        });

        // 폼 제출 처리
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '처리 중...';
            
            // 폼 데이터 수집
            const formData = {
                cartCode: document.getElementById('cartCode').value,
                name: document.getElementById('name').value,
                address: document.getElementById('address').value,
                orderType: document.getElementById('orderType').value,
                paidType: 'TOSS_PAYMENT',
                paymentKey: null,
                products: [],
                totalPrice: parseInt(document.getElementById('totalPrice').value)
            };
            
            // 상품 정보 수집
            const productItems = document.querySelectorAll('.product-item');
            productItems.forEach(item => {
                const productCode = item.querySelector('input[name*="productCode"]').value;
                const quantity = parseInt(item.querySelector('input[name*="quantity"]').value);
                const price = parseInt(item.querySelector('input[name*="price"]').value);
                const image = item.querySelector('input[name*="image"]').value;
                
                formData.products.push({
                    productCode: productCode,
                    quantity: quantity,
                    price: price,
                    image: image || ''
                });
            });
            
            try {
                const userCode = document.getElementById('userCode').value;
                const response = await fetch('/api/orders/cartItems', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Code': userCode
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.redirected) {
                    // 리다이렉트가 발생한 경우 (토스 결제)
                    window.location.href = response.url;
                } else if (response.ok) {
                    const result = await response.json();
                    alert('주문이 생성되었습니다!');
                    console.log('주문 생성 완료:', result);
                } else {
                    const error = await response.json();
                    alert('주문 생성 실패: ' + (error.message || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('주문 생성 실패:', error);
                alert('주문 생성 중 오류가 발생했습니다: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '주문하기';
            }
        });
    </script>
</body>
</html>

